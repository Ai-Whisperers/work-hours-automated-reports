name: Activity Tracker Deployment

on:
  workflow_dispatch:
    inputs:
      enable_activity_tracker:
        description: 'Enable activity monitoring'
        required: false
        default: 'false'
        type: boolean
      enable_github_tracker:
        description: 'Enable GitHub commit tracking'
        required: false
        default: 'true'
        type: boolean
      duration_minutes:
        description: 'Duration to run tracker (minutes)'
        required: false
        default: '60'

jobs:
  validate-config:
    name: Validate Tracker Configuration
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate Clockify connection
        env:
          CLOCKIFY_API_KEY: ${{ secrets.CLOCKIFY_API_KEY }}
          CLOCKIFY_WORKSPACE_ID: ${{ secrets.CLOCKIFY_WORKSPACE_ID }}
          CLOCKIFY_BASE_URL: ${{ secrets.CLOCKIFY_BASE_URL || 'https://api.clockify.me/api/v1' }}
        run: |
          python -c "
          from src.infrastructure.api_clients.clockify_sync_adapter import ClockifySyncAdapter
          from src.infrastructure.config import get_settings
          settings = get_settings()
          client = ClockifySyncAdapter(settings)
          if client.test_connection():
              print('✓ Clockify connection successful')
          else:
              print('✗ Clockify connection failed')
              exit(1)
          "

      - name: Validate GitHub credentials (if enabled)
        if: inputs.enable_github_tracker == 'true'
        env:
          GITHUB_USERNAME: ${{ secrets.TRACKER_GITHUB_USERNAME }}
          GITHUB_TOKEN: ${{ secrets.TRACKER_GITHUB_TOKEN }}
        run: |
          if [ -z "$GITHUB_USERNAME" ]; then
            echo "⚠ Warning: TRACKER_GITHUB_USERNAME not set"
            exit 1
          fi

          # Test GitHub API access
          if [ -n "$GITHUB_TOKEN" ]; then
            curl -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/users/$GITHUB_USERNAME/events" \
              -s -o /dev/null -w "%{http_code}" | grep -q "200" && \
              echo "✓ GitHub API access verified" || \
              echo "⚠ Warning: Could not verify GitHub API access"
          else
            echo "⚠ Warning: TRACKER_GITHUB_TOKEN not set (rate limits may apply)"
          fi

  run-github-tracker:
    name: Run GitHub Commit Tracker
    runs-on: ubuntu-latest
    needs: validate-config
    if: inputs.enable_github_tracker == 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run GitHub tracker
        timeout-minutes: ${{ fromJSON(inputs.duration_minutes) }}
        env:
          # Clockify Configuration
          CLOCKIFY_API_KEY: ${{ secrets.CLOCKIFY_API_KEY }}
          CLOCKIFY_WORKSPACE_ID: ${{ secrets.CLOCKIFY_WORKSPACE_ID }}
          CLOCKIFY_BASE_URL: ${{ secrets.CLOCKIFY_BASE_URL || 'https://api.clockify.me/api/v1' }}
          CLOCKIFY_TIMEOUT: ${{ secrets.CLOCKIFY_TIMEOUT || '30' }}
          CLOCKIFY_MAX_RETRIES: ${{ secrets.CLOCKIFY_MAX_RETRIES || '3' }}
          CLOCKIFY_DEFAULT_PROJECT_ID: ${{ secrets.CLOCKIFY_DEFAULT_PROJECT_ID }}

          # GitHub Tracker Configuration
          ENABLE_ACTIVITY_TRACKER: 'false'
          ENABLE_GITHUB_TRACKER: 'true'
          GITHUB_USERNAME: ${{ secrets.TRACKER_GITHUB_USERNAME }}
          GITHUB_TOKEN: ${{ secrets.TRACKER_GITHUB_TOKEN }}
          GITHUB_POLL_INTERVAL: ${{ secrets.GITHUB_POLL_INTERVAL || '60' }}
          GITHUB_COMMIT_DURATION: ${{ secrets.GITHUB_COMMIT_DURATION || '10' }}
        run: |
          echo "Starting GitHub Commit Tracker..."
          echo "Username: $GITHUB_USERNAME"
          echo "Poll interval: ${GITHUB_POLL_INTERVAL}s"
          echo "Commit duration: ${GITHUB_COMMIT_DURATION}min"
          echo "Running for: ${{ inputs.duration_minutes }} minutes"
          echo ""

          # Run tracker with timeout
          timeout ${{ inputs.duration_minutes }}m python tracker.py || true

          echo ""
          echo "Tracker stopped"

      - name: Upload tracker logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: tracker-logs-${{ github.run_id }}
          path: |
            clockify_github_state.json
            logs/
          retention-days: 7
        continue-on-error: true

  deployment-info:
    name: Deployment Information
    runs-on: ubuntu-latest
    if: always()
    needs: [validate-config, run-github-tracker]

    steps:
      - name: Display deployment summary
        run: |
          echo "## Activity Tracker Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Configuration:**" >> $GITHUB_STEP_SUMMARY
          echo "- Activity Monitoring: ${{ inputs.enable_activity_tracker }}" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Tracking: ${{ inputs.enable_github_tracker }}" >> $GITHUB_STEP_SUMMARY
          echo "- Duration: ${{ inputs.duration_minutes }} minutes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Activity monitoring requires desktop environment and is not supported in GitHub Actions." >> $GITHUB_STEP_SUMMARY
          echo "For local deployment, see [Activity Tracker Documentation](docs/activity-tracker.md)" >> $GITHUB_STEP_SUMMARY

      - name: Deployment recommendations
        run: |
          echo "## Recommendations for Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Activity Tracker**: Deploy on developer workstations" >> $GITHUB_STEP_SUMMARY
          echo "   - Use systemd (Linux), Task Scheduler (Windows), or launchd (macOS)" >> $GITHUB_STEP_SUMMARY
          echo "   - Store credentials securely using OS keyring" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "2. **GitHub Tracker**: Can run as service" >> $GITHUB_STEP_SUMMARY
          echo "   - Deploy on server with cron job or systemd timer" >> $GITHUB_STEP_SUMMARY
          echo "   - Use Docker for containerized deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "3. **Security**:" >> $GITHUB_STEP_SUMMARY
          echo "   - Rotate GitHub tokens regularly" >> $GITHUB_STEP_SUMMARY
          echo "   - Use least-privilege Clockify API keys" >> $GITHUB_STEP_SUMMARY
          echo "   - Monitor state files for integrity" >> $GITHUB_STEP_SUMMARY
